/* Use of this pixel is subject to the Amazon ad specs and policies at http://www.amazon.com/b/?&node=7253015011. Version number: 5, Changeset: Adding in phone number support for setUserData */
this["amzn-ara"]=this["amzn-ara"]||{},this["amzn-ara"].js=function(){"use strict";var e,t,n,r,o,s,a={nameLength:256,valueLength:1e3,eventNameLengthWarning:"Event name is longer than 256 characters.",parameterNameLengthWarning:"Length of parameter name exceeds 256 characters.",parameterValueLengthWarning:"Length of parameter value exceeds 1000 characters.",parameterKeyLengthWarning:"Length of parameter key exceeds 256 characters.",AIP_TOKEN_COOKIE_NAME:"aatToken",AIP_TOKEN_URL_QUERY_PARAM_NAME:"amznToken",NO_CONSENT_COOKIE_NAME:"AMZN-NoCookieConsent"};function i(){if(r)return n;r=1;const o=a,{checkCookieExists:s,getCookieValue:i}=t?e:(t=1,e={checkCookieExists:function(e){return document.cookie.split(";").some((t=>t.trim().startsWith(e)))},getCookieValue:function(e){return document.cookie.split(";").find((t=>t.trim().startsWith(e))).split("=")[1]}}),c=["gdpr","gdpr_pd","gdpr_consent"];function h(e,t,n){e.searchParams.set(t,n);const r=Array.from(e.searchParams.entries());e.search="",r.forEach((n=>{n[0]!==t&&e.searchParams.set(n[0],n[1])})),e.search+=`&${t}=${n}`}return n={createQueryParams:function(e,t){const{tagId:n,event:r,eventParams:a,consent:u}=t;if(e.searchParams.set("pid",n),e.searchParams.set("event",r),Array.isArray(a)&&h(e,"items",encodeURI(JSON.stringify(a))),Object.entries(a).forEach((([t,n])=>{c.includes(t)||(n||""===n)&&("object"==typeof n?e.searchParams.set(t,JSON.stringify(n)):e.searchParams.set(t,n))})),u&&c.forEach((t=>{u[t]&&e.searchParams.set(t,u[t])})),s(o.AIP_TOKEN_COOKIE_NAME)){const t=i(o.AIP_TOKEN_COOKIE_NAME);h(e,o.AIP_TOKEN_URL_QUERY_PARAM_NAME,t)}return e}}}function c(){if(s)return o;s=1;const{createQueryParams:e}=i(),t={"Google Chrome":106,Chromium:106};function n(){const{userAgentData:e}=navigator;return null!=e&&e.brands.some((({brand:e,version:n})=>t[e]<=n))}return o={performTriggerRegistration:async function(t){const{stage:r}=t;if(!n())return console.log("Browser is not supported for ARA"),Promise.resolve(!1);if(!document?.featurePolicy?.allowsFeature?.("attribution-reporting"))return console.log("ARA is not enabled in browser"),Promise.resolve(!1);const o=function(e){let t;switch(e.toLowerCase()){case"beta":case"test":t="https://beta-ara.paa-reporting-advertising.amazon/aat";break;case"gamma":t="https://gamma-ara.paa-reporting-advertising.amazon/aat";break;default:t="https://ara.paa-reporting-advertising.amazon/aat"}return new URL(t)}(r),s=e(o,t);return console.log("Performing ARA Registration",s.toString()),async function(e){return window?.fetch(e,{credentials:"same-origin",keepalive:!0,attributionReporting:{eventSourceEligible:!1,triggerEligible:!0}})}(s)}}}const h=a;function u(e){this.endpoints=e,this.region="NA",this.stage="PROD",this.tags={},this.tcfv2={}}function p(e,t,n){const r=document.createElement("iframe");r.style.display="none",r.setAttribute("src",e),r.setAttribute("id",`tag_fire_${t}_${n}_${(new Date).getTime()}`),document.body.appendChild(r)}u.prototype.addTag=function(e,t){const n=null==t?e:t;this.tags[n]=e},u.prototype.getTagIds=function(e){const{tags:t}=this;return e.map((function(e){return t[e]||e}))},u.prototype.trackEvent=async function(e,t,n){return this.trackEventWithTags(e,t,n,Object.keys(this.tags))},u.prototype.trackRequest=async function(e,t,n,r){try{await async function(e,t,n,r,o){let s=`${e}?pid=${t}&event=${n}`;const a=["gdpr","gdpr_pd","gdpr_consent"],c=[];if(n.length>h.nameLength&&c.push(`${h.eventNameLengthWarning}, ${n}`),Array.isArray(r)?(r.forEach((function(e){Object.keys(e)[0].length>h.nameLength&&c.push(`${h.parameterNameLengthWarning}, ${Object.keys(e)[0]}`),e[Object.keys(e)[0]].length>h.valueLength&&c.push(`${h.parameterValueLengthWarning}, ${e[Object.keys(e)[0]]}`)})),s+=`&items=${encodeURI(JSON.stringify(r))}`):r&&Object.keys(r)&&Object.keys(r).filter((function(e){return!a.includes(e)})).forEach((function(e){let t;e.length>h.nameLength&&c.push(`${h.parameterNameLengthWarning}, ${e}`),t=r[e],t||""===t?(t.length>h.valueLength?c.push(`${h.parameterValueLengthWarning}, ${t}`):Object.keys(t)&&Object.keys(t)[0]&&Object.keys(t).forEach((function(e){e.length>h.nameLength&&c.push(`${h.parameterKeyLengthWarning}, ${e}`),t[e].length>h.valueLength&&c.push(`${h.parameterValueLengthWarning}, ${t[e]}`)})),"object"==typeof t&&(t=encodeURI(JSON.stringify(t))),s+=`&${e}=${t}`):console.warn(`Key ${e} has no value`)})),c.length>0){const e=`Event has ${c.length} validation errors.`;return console.warn(e),console.warn(c),Promise.reject(e)}if(o&&a.forEach((function(e){o[e]&&(s+=`&${e}=${o[e]}`)})),document.cookie.indexOf(h.AIP_TOKEN_COOKIE_NAME)>=0){const e=document.cookie.split(";").find((e=>e.trim().startsWith(`${h.AIP_TOKEN_COOKIE_NAME}=`)));if(void 0!==e){const t=e.substring(e.indexOf("=")+1);s+=`&${h.AIP_TOKEN_URL_QUERY_PARAM_NAME}=${t}`}}{const{createQueryParams:a}=i();s=a(new URL(e),{tagId:t,event:n,eventParams:r,consent:o}).href}if(!window.fetch||void 0===window.fetch)return p(s,t,n);try{const e=await fetch(s,{method:"get",credentials:"include",mode:"no-cors",keepalive:"true"});return Promise.resolve(e)}catch(e){return console.warn("Event request via fetch failed, reverting to iframe"),p(s,t,n)}}(t,e,n,r,this.tcfv2[e]),console.log("Event request succeeded.")}catch(e){return console.warn("Event request failed.",e),Promise.reject(e)}try{const{performTriggerRegistration:t}=c();await t({stage:this.stage,consent:this.tcfv2[e],tagId:e,event:n,eventParams:r}),console.log("Finish ARA trigger registration")}catch(e){console.warn("ARA trigger registration failed",e)}return Promise.resolve()},u.prototype.trackEventWithTags=async function(e,t,n,r){const o=this.getPixelEndpoint(this.region),s=t||{},a="No event specified.",i="No valid endpoint.";if(!e)return console.warn(a),Promise.reject(a);if(!o)return console.warn(i),Promise.reject(i);n&&(s.ts=n);const c=this.getTagIds(r).map((t=>this.trackRequest(t,o,e,s)));return Promise.all(c)},u.prototype.trackPixel=function(e,t,n){const r=this;let o;const s={};let a=t||"";a=a.split("?"),o=a.length>1?a[1]:a[0],o=o.split("&"),o.forEach((function(e){const t=e.split("=");let n,o;t.length<=1||("ex-fargs"===t[0]?(n=r.parsePixelArgs(t[1],"&"),s.fargs_id=n.id,s.fargs_type=n.type):"ex-hargs"===t[0]&&(o=r.parsePixelArgs(t[1],";"),s.hargs_c=o.c,s.hargs_p=o.p))})),this.validatePixelData(s),Object.keys(s).forEach((function(e){s[e]||delete s[e]})),this.trackEvent(e,s,n)},u.prototype.addTcfv2=function(e){this.addTcfv2WithTags(e,Object.keys(this.tags))},u.prototype.addTcfv2WithTags=function(e,t){const{tcfv2:n}=this;this.getTagIds(t).forEach((function(t){n[t]=e}))},u.prototype.getPixelEndpoint=function(e){const t=this.endpoints[e.toUpperCase()];return""===t||null==t?(console.warn("Endpoint does not exist, please check your region configuration!"),null):t},u.prototype.parsePixelArgs=function(e,t){let n=decodeURIComponent(e);const r={};return n=n.replace(/\?/g,""),n.split(t).forEach((function(e){const t=e.split("=");if(t.length>1){const[e,n]=t;r[e]=n}})),r},u.prototype.validatePixelData=function(e){const t=e.hargs_c&&e.hargs_p,n=e.fargs_id&&e.fargs_type;t||n||console.warn("Invalid arguments for a trackPixel event, please check your implementation!")},u.prototype.setRegion=function(e){this.region=e},u.prototype.setStage=function(e){this.stage=e};var d=u;function l(e,t,n){this.eventTracker=e,this.setUserDataHandler=t,this.aatEventsQueue=[],this.isSetUserDataInProcess=!1,this.eventListener=n}l.prototype.proccessCommandQueue=async function(e){const t=this,n=[];return(e||[]).forEach((function(e){n.push(t.proccessCommand(e[0],e[1]))})),Promise.all(n)},l.prototype.proccessCommand=async function(e,t=(new Date).getTime()){const n=Array.prototype.slice.call(e),r=e[0],o=`Unsupported tag command "${r}"`,s={trackevent:(e,t)=>this.trackEvent(e,t),trackpixel:(e,t)=>this.trackPixel(e,t),pixel:(e,t)=>this.withTag(e,t),withtag:(e,t)=>this.withTag(e,t),addpixel:e=>this.addTag(e),addtag:e=>this.addTag(e),addtcfv2:e=>this.addTcfv2(e),setregion:e=>this.setRegion(e),setstage:e=>this.setStage(e),setuserdata:e=>this.setUserData(e)},a=r.toLowerCase();return s[a]?s[a](n,t):(console.warn(o),Promise.reject(o))},l.prototype.setUserData=async function(e){this.isSetUserDataInProcess=!0;try{await this.setUserDataHandler.setUserData(e),this.isSetUserDataInProcess=!1,this.processAatEventsQueue()}catch(e){return console.warn(e),Promise.reject(e)}return Promise.resolve()},l.prototype.processAatEventsQueue=function(){if(this.aatEventsQueue.length)for(;this.aatEventsQueue.length;)try{const{argumentArray:e,timestamp:t,tagLabel:n}=this.aatEventsQueue.pop();this.trackEvent(e,t,n)}catch(e){console.warn(e)}},l.prototype.trackEvent=async function(e,t,n){if(this.isSetUserDataInProcess)return this.aatEventsQueue.unshift({argumentArray:e,timestamp:t,tagLabel:n}),Promise.resolve();const r=e[1],o=e[2];return void 0!==n?this.eventTracker.trackEventWithTags(r,o,t,[n]):this.eventTracker.trackEvent(r,o,t)},l.prototype.trackPixel=function(e,t){this.eventTracker.trackPixel("__pixel__",e[1],t)},l.prototype.withTag=async function(e,t){const n=e[1],r=e[2]||"",o=`Unsupported command "${r}" used after "withTag" command`;switch(r.toUpperCase()){case"TRACKEVENT":return this.trackEvent(e.slice(2),t,n);case"ADDTCFV2":this.addTcfv2(e.slice(2),n);break;default:return console.warn(o),Promise.reject(o)}return Promise.resolve()},l.prototype.addTag=function(e){const t=e[2],n=e[1];this.eventTracker.addTag(n,t)},l.prototype.addTcfv2=function(e,t){const n=e[1];void 0!==t?this.eventTracker.addTcfv2WithTags(n,[t]):this.eventTracker.addTcfv2(n)},l.prototype.setRegion=function(e){const t=e[1].toUpperCase();this.eventTracker.setRegion(t)},l.prototype.setStage=function(e){const t=e[1].toUpperCase();this.eventTracker.setStage(t)},l.prototype.listen=function(){this.eventListener.init()};var g=l;const f=a,m="AIPToken",y="cookieExpiry",E={method:"POST",mode:"cors",cache:"no-cache",credentials:"omit",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer-when-downgrade"};function v(){}v.prototype.formatRequestBody=function(e){const t={};if(null!==e.gdpr&&(t.gdpr=e.gdpr.enabled?1:0,null!==e.gdpr.consent&&(t.gdprConsent=e.gdpr.consent)),null===e.hashedRecords)throw Error("hashedRecords array is null");if(0===e.hashedRecords.length)throw Error("hashedRecords array is empty");return t.hashedRecords=e.hashedRecords,null!==e.ttl&&(t.ttl=e.ttl),t},v.prototype.requestToken=async function(e){const t={...E,body:JSON.stringify(e)},n=await fetch("https://tk.amazon-adsystem.com/envelope",t);if(n.ok){return await n.json()}const r=await n.text();throw Error(r)},v.prototype.isCookiePresent=function(e){return void 0!==document.cookie.split(";").find((t=>t.trim().startsWith(`${e}=`)))},v.prototype.writeCookie=function(e,t,n){const r=new Date(n).toUTCString();document.cookie=`${e}=${t}; expires=${r}; SameSite=Strict; secure=true;`},v.prototype.renewToken=async function(e){if(!this.isCookiePresent(f.AIP_TOKEN_COOKIE_NAME)&&!this.isCookiePresent(f.NO_CONSENT_COOKIE_NAME))try{const t=this.formatRequestBody(e),n=await this.requestToken(t);return""===n[m]?this.writeCookie(f.NO_CONSENT_COOKIE_NAME,n[m],n[y]):this.writeCookie(f.AIP_TOKEN_COOKIE_NAME,n[m],n[y]),n}catch(e){console.error(e)}return"no-op"},v.prototype.deleteToken=async function(){this.isCookiePresent(f.AIP_TOKEN_COOKIE_NAME)&&this.writeCookie(f.AIP_TOKEN_COOKIE_NAME,"0",1),this.isCookiePresent(f.NO_CONSENT_COOKIE_NAME)&&this.writeCookie(f.NO_CONSENT_COOKIE_NAME,"0",1)},v.prototype.updateToken=async function(e){return await this.deleteToken(),this.renewToken(e)};var k=v;function T(e){this.tokenHandler=e}async function _(e){const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}function w(e){return null!=e&&"string"==typeof e&&e.length>0}T.prototype.setUserData=async function(e){const t={gdpr:{enabled:!1,consent:""},hashedRecords:[],ttl:9600},n=e[1];n.gdpr&&(t.gdpr=n.gdpr),n.ttl&&(t.ttl=n.ttl);const r=/\b[A-Fa-f0-9]{64}\b/;if(w(n.email)){const e={type:"email",record:""};if(n.email=n.email.trim().toLowerCase(),r.test(n.email))e.record=n.email;else try{e.record=await _(n.email)}catch(e){return console.error(e),Promise.reject(e)}t.hashedRecords.push(e)}if(w(n.phonenumber)){const e={type:"phonenumber",record:""};if(r.test(n.phonenumber))e.record=n.phonenumber;else try{e.record=await _(function(e){let t=e.replace(/[^\d+]+/g,"");return t=t.replace(/^00/,"+"),t.match(/^1/)&&(t=`+${t}`),t.match(/^\+/)||(t=`+1${t}`),t=t.replace(/^\+/,""),t}(n.phonenumber))}catch(e){return console.error(e),Promise.reject(e)}t.hashedRecords.push(e)}return t.hashedRecords.length>0?this.tokenHandler.updateToken(t):Promise.resolve()};var A,P;function O(){if(P)return A;P=1;const e="amzn-ad-tag-",t=["AddToShoppingCart","Application","Checkout","Contact","Lead","Off-AmazonPurchases","Search","Signup","Subscribe"];function n(n){this.AD_TAG_HTML_PREFIX=e,this.AD_TAG_EVENT_NAMES=t,this.eventTracker=n}return n.prototype.init=function(){const{eventTracker:t}=this;this.AD_TAG_EVENT_NAMES.forEach((function(n){const r=e+n;document.getElementById(r)&&document.getElementById(r).addEventListener("click",(function(){t.trackEvent(n,{},(new Date).getTime())}))}))},n.prototype.addEventName=function(e){-1===t.indexOf(e)&&t.push(e)},n.prototype.overrideEventPrefix=function(e){this.AD_TAG_HTML_PREFIX=e},n.prototype.overrideEventName=function(e,n){const r=t.indexOf(e);-1!==r&&(t[r]=n)},A=n}const N=d,C=g,b=k,I=T,R={NA:"https://s.amazon-adsystem.com/iu3",EU:"https://aax-eu.amazon-adsystem.com/s/iu3",FE:"https://aax-fe.amazon-adsystem.com/s/iu3"};return function(){const e=new N(R),t=new b,n=new I(t);let r=new C(e,n);{const t=new(O())(e);r=new C(e,n,t)}window.amzn&&window.amzn.q&&r.proccessCommandQueue(window.amzn.q).then((()=>{console.log("Successfully processed event queue")})).catch((e=>{console.error("Error processing event queue",e)})),window.amzn=async function(...e){return r.proccessCommand(e).catch((e=>{console.error("Error processing command",e)}))},window.renewToken=async function(e){return t.renewToken(e)},window.updateToken=async function(e){return t.updateToken(e)},window.deleteToken=async function(){return t.deleteToken()}}(),{}}();
